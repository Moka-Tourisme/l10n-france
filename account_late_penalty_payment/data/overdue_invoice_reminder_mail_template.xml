<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <data>
        <!-- Surcharge du modèle de mail existant -->
        <record id="overdue_invoice_reminder_mail_template_inherit" model="mail.template">
            <field name="name">Overdue Invoice Reminder with Penalties</field>
            <field name="model_id" ref="account_invoice_overdue_reminder.overdue_invoice_reminder_mail_template"/>
            <field name="body_html" type="html">
                <div style="margin: 0px; padding: 0px; font-size: 13px;">
                    <p>Dear customer,</p>
                    <p>According to our books, the following invoices are overdue:</p>

                    <!-- Table des factures existant -->
                    <table style="border-spacing: 0; border-collapse: collapse; width: 100%; text-align: center;">
                        <tr>
                            <th style="padding: 5px; border: 1px solid black;">Invoice Number</th>
                            <th style="padding: 5px; border: 1px solid black;">Invoice Date</th>
                            <th style="padding: 5px; border: 1px solid black;">Payment Terms</th>
                            <th style="padding: 5px; border: 1px solid black;">Due Date</th>
                            <th style="padding: 5px; border: 1px solid black;">Order Ref.</th>
                            <th style="padding: 5px; border: 1px solid black;">Type</th>
                            <th style="padding: 5px; border: 1px solid black;">Total Untaxed</th>
                            <th style="padding: 5px; border: 1px solid black;">Total</th>
                            <th style="padding: 5px; border: 1px solid black;">Residual</th>
                            <th style="padding: 5px; border: 1px solid black;">Past Reminders</th>
                        </tr>
                        <t t-foreach="object.invoice_ids.sorted(key='invoice_date')" t-as="inv">
                            <tr style="background-color: % if inv.move_type == 'out_refund': LightGray % endif">
                                <td style="padding: 5px; border: 1px solid black;"><t t-out="inv.name" /></td>
                                <td style="padding: 5px; border: 1px solid black;"><t t-out="inv.invoice_date" /></td>
                                <td style="padding: 5px; border: 1px solid black;"><t t-out="inv.invoice_payment_term_id.name or ''" /></td>
                                <td style="padding: 5px; border: 1px solid black;"><t t-out="inv.invoice_date_due" /></td>
                                <td style="padding: 5px; border: 1px solid black;"><t t-out="inv.ref or ''" /></td>
                                <td style="padding: 5px; border: 1px solid black;"><t t-out="dict(inv.fields_get(allfields=['move_type'])['move_type']['selection'])[inv.move_type]" /></td>
                                <td style="padding: 5px; border: 1px solid black; text-align: right;"><t t-out="format_amount(inv.amount_untaxed, inv.currency_id)" /></td>
                                <td style="padding: 5px; border: 1px solid black; text-align: right;"><t t-out="format_amount(inv.amount_total, inv.currency_id)" /></td>
                                <td style="padding: 5px; border: 1px solid black; text-align: right;"><t t-out="format_amount(inv.amount_residual, inv.currency_id)" /></td>
                                <td style="padding: 5px; border: 1px solid black;"><t t-out="inv.overdue_reminder_counter" /></td>
                            </tr>
                        </t>
                    </table>
                    <t t-foreach="object.invoice_ids.sorted(key='invoice_date')" t-as="inv">
                        <!-- Ajout du tableau de pénalités si des pénalités existent -->
                        <t t-if="inv.penalty_line_ids">
                            <p>The following penalties are also applicable for the overdue invoices:</p>

                            <!-- Tableau des pénalités -->
                            <table style="border-spacing: 0; border-collapse: collapse; width: 100%; text-align: center;">
                                <tr>
                                    <th style="padding: 5px; border: 1px solid black;">Base de calcul</th>
                                    <th style="padding: 5px; border: 1px solid black;">Date de la période</th>
                                    <th style="padding: 5px; border: 1px solid black;">Jours de retard</th>
                                    <th style="padding: 5px; border: 1px solid black;">Taux d'intérêt (%)</th>
                                    <th style="padding: 5px; border: 1px solid black;">Coefficient</th>
                                    <th style="padding: 5px; border: 1px solid black;">Montant de la pénalité</th>
                                </tr>
                                <t t-foreach="inv.penalty_line_ids" t-as="penalty">
                                    <tr>
                                        <td style="padding: 5px; border: 1px solid black;"><t t-out="penalty.residual_base" /></td>
                                        <td style="padding: 5px; border: 1px solid black;"><t t-out="penalty.date_period_from" /></td>
                                        <td style="padding: 5px; border: 1px solid black;"><t t-out="penalty.date_period_to" /></td>
                                        <td style="padding: 5px; border: 1px solid black;"><t t-out="penalty.days" /></td>
                                        <td style="padding: 5px; border: 1px solid black;"><t t-out="penalty.rate" /></td>
                                        <td style="padding: 5px; border: 1px solid black;"><t t-out="penalty.coefficient" /></td>
                                        <td style="padding: 5px; border: 1px solid black; text-align: right;"><t t-out="penalty.penalty" /></td>
                                    </tr>
                                </t>
                            </table>
                        </t>
                    </t>

                    <p>If you made a payment for these invoices a few days ago, please ignore this email.</p>

                    <t t-if="object.company_id.overdue_reminder_attach_invoice">
                        <p>You will find enclosed the overdue invoices.</p>
                    </t>

                    <t t-if="object.counter > 2">
                        <p>Despite several reminders, we are disappointed to see that these overdue invoices are still unpaid. Please ensure the payment of the overdue invoices as soon as possible to avoid further actions.</p>
                    </t>

                    <p>Regards,</p>

                    <t t-if="user.signature">
                        <p><t t-out="user.signature or ''" /></p>
                    </t>
                </div>
            </field>
        </record>
    </data>
</odoo>
